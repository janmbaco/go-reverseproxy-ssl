{{define "virtualhost-form-content"}}
<div class="virtualhost-form">
    <div class="page-header">
        <div class="header-content">
            <h1>
                {{if .IsEdit}}
                    <i class="fas fa-edit"></i> Edit Virtual Host
                {{else}}
                    <i class="fas fa-plus"></i> New Virtual Host
                {{end}}
            </h1>
            <p class="subtitle">
                {{if .IsEdit}}
                    Modify the virtual host configuration
                {{else}}
                    Create a new virtual host for your reverse proxy
                {{end}}
            </p>
        </div>
        <div class="header-actions">
            <a href="/virtualhosts" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <form id="virtualhostForm" class="form-container">
        <div class="form-section">
            <h2><i class="fas fa-cogs"></i> Virtual Host Type</h2>

            <div class="form-group">
                <label for="virtualHostType">Type</label>
                <select id="virtualHostType" name="virtualHostType" required {{if .IsEdit}}disabled{{end}}>
                    <option value="web" {{if eq .VirtualHostType "web"}}selected{{end}}>Web (HTTP/HTTPS)</option>
                    <option value="grpc-web" {{if eq .VirtualHostType "grpc-web"}}selected{{end}}>gRPC-Web</option>
                </select>
                <small>{{if .IsEdit}}Virtual host type cannot be changed after creation{{else}}Select the type of virtual host to configure{{end}}</small>
            </div>
        </div>

        <div class="form-section">
            <h2><i class="fas fa-info-circle"></i> Basic Configuration</h2>

            <div class="form-group">
                <label for="from">From (Domain)</label>
                <input type="text" id="from" name="from" value="{{.VirtualHost.From}}" required
                       placeholder="example.com">
                <small>The domain name that clients will use to access this virtual host</small>
            </div>

            <!-- Web Virtual Host Fields -->
            <div id="webFields" class="virtualhost-type-fields {{if ne .VirtualHostType "web"}}hidden{{end}}">
                <div class="form-row">
                    <div class="form-group">
                        <label for="scheme">Scheme</label>
                        <select id="scheme" name="scheme" required>
                            <option value="http" {{if eq .VirtualHost.Scheme "http"}}selected{{end}}>HTTP</option>
                            <option value="https" {{if eq .VirtualHost.Scheme "https"}}selected{{end}}>HTTPS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="hostName">Host Name</label>
                        <input type="text" id="hostName" name="hostName" value="{{.VirtualHost.HostName}}" required
                               placeholder="localhost">
                    </div>

                    <div class="form-group">
                        <label for="port">Port</label>
                        <input type="number" id="port" name="port" value="{{.VirtualHost.Port}}" required
                               placeholder="8080">
                    </div>
                </div>

                <div class="form-group">
                    <label for="path">Path (Optional)</label>
                    <input type="text" id="path" name="path" value="{{.VirtualHost.Path}}"
                           placeholder="/api">
                    <small>Optional path prefix for routing</small>
                </div>
            </div>

            <!-- gRPC-Web Virtual Host Fields -->
            <div id="grpcWebFields" class="virtualhost-type-fields {{if ne .VirtualHostType "grpc-web"}}hidden{{end}}">
                <div class="form-row">
                    <div class="form-group">
                        <label for="grpcHostName">Host Name</label>
                        <input type="text" id="grpcHostName" name="grpcHostName" value="{{if .GrpcWebVirtualHost}}{{.GrpcWebVirtualHost.HostName}}{{end}}" required
                               placeholder="grpc-server">
                        <small>The hostname of the gRPC server</small>
                    </div>

                    <div class="form-group">
                        <label for="grpcPort">Port</label>
                        <input type="number" id="grpcPort" name="grpcPort" value="{{if .GrpcWebVirtualHost}}{{.GrpcWebVirtualHost.Port}}{{end}}" required
                               placeholder="7656">
                        <small>The port of the gRPC server</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="authority">Authority</label>
                    <input type="text" id="authority" name="authority" value="{{if .GrpcWebVirtualHost}}{{.GrpcWebVirtualHost.GrpcWebProxy.Authority}}{{end}}"
                           placeholder="grpc-server:7656">
                    <small>The authority header to use for gRPC requests</small>
                </div>

                <div class="form-group">
                    <label>gRPC Services & Methods</label>
                    <div id="grpcServicesContainer">
                        {{if .GrpcWebVirtualHost}}
                        {{range $service, $methods := .GrpcWebVirtualHost.GrpcWebProxy.GrpcServices}}
                        <div class="grpc-service-item">
                            <div class="service-header">
                                <input type="text" name="grpcServiceName[]" value="{{$service}}" placeholder="service.Name" required>
                                <button type="button" class="btn btn-small btn-danger remove-service">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="methods-container">
                                {{range $methods}}
                                <div class="method-item">
                                    <input type="text" name="grpcMethods[]" value="{{.}}" placeholder="MethodName" required>
                                    <input type="hidden" name="grpcServiceName[]" value="{{$service}}">
                                    <button type="button" class="btn btn-small btn-danger remove-method">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {{end}}
                                <button type="button" class="btn btn-small btn-secondary add-method">
                                    <i class="fas fa-plus"></i> Add Method
                                </button>
                            </div>
                        </div>
                        {{end}}
                        {{end}}
                    </div>
                    <button type="button" id="addGrpcService" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> Add gRPC Service
                    </button>
                    <small>Define which gRPC services and methods should be exposed via gRPC-Web</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isTransparentServer" name="isTransparentServer"
                               {{if .GrpcWebVirtualHost}}{{if .GrpcWebVirtualHost.GrpcWebProxy.IsTransparentServer}}checked{{end}}{{end}}>
                        Transparent Server
                    </label>
                    <small>When enabled, the gRPC server acts as a transparent proxy</small>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2><i class="fas fa-shield-alt"></i> SSL/TLS Configuration</h2>

            <div class="cert-notice">
                <div class="notice-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="notice-content">
                    <h4>Certificate Information</h4>
                    <p>If no custom certificate is uploaded, Let's Encrypt will automatically provide and renew SSL certificates for this domain.</p>
                    <p><strong>Requirements for Let's Encrypt:</strong></p>
                    <ul>
                        <li>DNS must point to this server</li>
                        <li>Ports 80 and 443 must be accessible</li>
                        <li>Domain must be publicly resolvable</li>
                    </ul>
                </div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="useServerCert" name="useServerCert"
                           {{if .VirtualHost.ServerCertificate}}checked{{end}}>
                    Use custom server certificate (instead of Let's Encrypt)
                </label>
            </div>

            <div id="serverCertFields" class="form-group {{if not .VirtualHost.ServerCertificate}}hidden{{end}}">
                <label>Server Certificate File</label>
                <div class="file-input-container">
                    {{if .VirtualHost.ServerCertificate}}
                    <div class="current-file-display">
                        <span class="file-name">{{.VirtualHost.ServerCertificate.PublicKey}}</span>
                        <button type="button" class="btn-file-action btn-load" onclick="document.getElementById('serverCertFile').click()">
                            <i class="fas fa-upload"></i> Replace
                        </button>
                        <button type="button" class="btn-file-action btn-clear" onclick="clearServerCert()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {{else}}
                    <div class="file-drop-zone" onclick="document.getElementById('serverCertFile').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload or drag & drop</p>
                        <small>SSL certificate file (.pem, .crt, or .cer)</small>
                    </div>
                    {{end}}
                    <input type="file" id="serverCertFile" name="serverCertFile" accept=".pem,.crt,.cer" style="display: none;">
                </div>

                <label>Private Key File</label>
                <div class="file-input-container">
                    {{if .VirtualHost.ServerCertificate}}
                    <div class="current-file-display">
                        <span class="file-name">{{.VirtualHost.ServerCertificate.PrivateKey}}</span>
                        <button type="button" class="btn-file-action btn-load" onclick="document.getElementById('serverKeyFile').click()">
                            <i class="fas fa-upload"></i> Replace
                        </button>
                        <button type="button" class="btn-file-action btn-clear" onclick="clearServerKey()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {{else}}
                    <div class="file-drop-zone" onclick="document.getElementById('serverKeyFile').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload or drag & drop</p>
                        <small>Private key file (.key or .pem)</small>
                    </div>
                    {{end}}
                    <input type="file" id="serverKeyFile" name="serverKeyFile" accept=".key,.pem" style="display: none;">
                </div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="useClientCert" name="useClientCert"
                           {{if .VirtualHost.ClientCertificate}}checked{{end}}>
                    Require client certificate (mTLS)
                </label>
            </div>

            <div id="clientCertFields" class="form-group {{if not .VirtualHost.ClientCertificate}}hidden{{end}}">
                <label>Client Certificate Authority File</label>
                <div class="file-input-container">
                    {{if .VirtualHost.ClientCertificate}}
                    <div class="current-file-display">
                        <span class="file-name">{{index .VirtualHost.ClientCertificate.CaPem 0}}</span>
                        <button type="button" class="btn-file-action btn-load" onclick="document.getElementById('clientCertFile').click()">
                            <i class="fas fa-upload"></i> Replace
                        </button>
                        <button type="button" class="btn-file-action btn-clear" onclick="clearClientCert()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {{else}}
                    <div class="file-drop-zone" onclick="document.getElementById('clientCertFile').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload or drag & drop</p>
                        <small>CA certificate file (.pem, .crt, or .cer)</small>
                    </div>
                    {{end}}
                    <input type="file" id="clientCertFile" name="clientCertFile" accept=".pem,.crt,.cer" style="display: none;">
                </div>
            </div>
        </div>

        <!-- gRPC-Web Specific Configuration -->
        <div id="grpcWebConfigSection" class="form-section {{if ne .VirtualHostType "grpc-web"}}hidden{{end}}">
            <h2><i class="fas fa-network-wired"></i> gRPC-Web Configuration</h2>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="allowAllOrigins" name="allowAllOrigins"
                           {{if .GrpcWebVirtualHost}}{{if .GrpcWebVirtualHost.GrpcWebProxy.AllowAllOrigins}}checked{{end}}{{end}}>
                    Allow all origins
                </label>
                <small>When enabled, allows requests from any origin (not recommended for production)</small>
            </div>

            <div id="allowedOriginsGroup" class="form-group {{if .GrpcWebVirtualHost}}{{if .GrpcWebVirtualHost.GrpcWebProxy.AllowAllOrigins}}hidden{{end}}{{end}}">
                <label for="allowedOrigins">Allowed Origins</label>
                <div id="allowedOriginsContainer">
                    {{if .GrpcWebVirtualHost}}
                    {{range .GrpcWebVirtualHost.GrpcWebProxy.AllowedOrigins}}
                    <div class="origin-item">
                        <input type="text" name="allowedOrigins[]" value="{{.}}" placeholder="https://example.com" required>
                        <button type="button" class="btn btn-small btn-danger remove-origin">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {{end}}
                    {{end}}
                </div>
                <button type="button" id="addAllowedOrigin" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> Add Origin
                </button>
                <small>Specify allowed origins for CORS (leave empty to allow all when "Allow all origins" is checked)</small>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="useWebSockets" name="useWebSockets"
                           {{if .GrpcWebVirtualHost}}{{if .GrpcWebVirtualHost.GrpcWebProxy.UseWebSockets}}checked{{end}}{{end}}>
                    Use WebSockets
                </label>
                <small>Enable WebSocket support for bidirectional streaming</small>
            </div>

            <div class="form-group">
                <label for="allowedHeaders">Allowed Headers</label>
                <div id="allowedHeadersContainer">
                    {{if .GrpcWebVirtualHost}}
                    {{range .GrpcWebVirtualHost.GrpcWebProxy.AllowedHeaders}}
                    <div class="header-item">
                        <input type="text" name="allowedHeaders[]" value="{{.}}" placeholder="x-custom-header" required>
                        <button type="button" class="btn btn-small btn-danger remove-header">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {{end}}
                    {{end}}
                </div>
                <button type="button" id="addAllowedHeader" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> Add Header
                </button>
                <small>Specify additional allowed headers for CORS requests</small>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="history.back()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save"></i>
                {{if .IsEdit}}Update{{else}}Create{{end}} Virtual Host
            </button>
        </div>
    </form>
</div>

<script>
document.getElementById('useServerCert').addEventListener('change', function() {
    document.getElementById('serverCertFields').classList.toggle('hidden', !this.checked);
});

document.getElementById('useClientCert').addEventListener('change', function() {
    document.getElementById('clientCertFields').classList.toggle('hidden', !this.checked);
});

function clearServerCert() {
    const input = document.getElementById('serverCertFile');
    input.value = '';
    const container = input.closest('.file-input-container');
    const currentDisplay = container.querySelector('.current-file-display');
    const dropZone = container.querySelector('.file-drop-zone');
    if (currentDisplay) {
        currentDisplay.remove();
    }
    if (dropZone) {
        dropZone.style.display = 'block';
    }
}

function clearServerKey() {
    const input = document.getElementById('serverKeyFile');
    input.value = '';
    const container = input.closest('.file-input-container');
    const currentDisplay = container.querySelector('.current-file-display');
    const dropZone = container.querySelector('.file-drop-zone');
    if (currentDisplay) {
        currentDisplay.remove();
    }
    if (dropZone) {
        dropZone.style.display = 'block';
    }
}

function clearClientCert() {
    const input = document.getElementById('clientCertFile');
    input.value = '';
    const container = input.closest('.file-input-container');
    const currentDisplay = container.querySelector('.current-file-display');
    const dropZone = container.querySelector('.file-drop-zone');
    if (currentDisplay) {
        currentDisplay.remove();
    }
    if (dropZone) {
        dropZone.style.display = 'block';
    }
}

// Drag & drop support
function setupDragDrop(dropZoneSelector, inputId) {
    const dropZones = document.querySelectorAll(dropZoneSelector);
    const input = document.getElementById(inputId);
    
    dropZones.forEach(dropZone => {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            }, false);
        });
        
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                input.files = files;
                input.dispatchEvent(new Event('change'));
            }
        }, false);
    });
}

// Setup drag & drop for all file inputs
setupDragDrop('.file-drop-zone', 'serverCertFile');
setupDragDrop('.file-drop-zone', 'serverKeyFile');
setupDragDrop('.file-drop-zone', 'clientCertFile');

// Update file display when files are selected
document.getElementById('serverCertFile').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        updateFileDisplay('serverCert', e.target.files[0].name);
    }
});

document.getElementById('serverKeyFile').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        updateFileDisplay('serverKey', e.target.files[0].name);
    }
});

document.getElementById('clientCertFile').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        updateFileDisplay('clientCert', e.target.files[0].name);
    }
});

function updateFileDisplay(type, fileName) {
    const input = document.getElementById(type + 'File');
    const container = input.closest('.file-input-container');
    const currentDisplay = container.querySelector('.current-file-display');
    const dropZone = container.querySelector('.file-drop-zone');
    
    if (dropZone) {
        dropZone.style.display = 'none';
        
        let displayDiv = currentDisplay;
        if (!displayDiv) {
            displayDiv = document.createElement('div');
            displayDiv.className = 'current-file-display';
            displayDiv.innerHTML = `
                <span class="file-name">${fileName}</span>
                <button type="button" class="btn-file-action btn-load" onclick="document.getElementById('${type}File').click()">
                    <i class="fas fa-upload"></i> Replace
                </button>
                <button type="button" class="btn-file-action btn-clear" onclick="clear${type.charAt(0).toUpperCase() + type.slice(1)}()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.insertBefore(displayDiv, dropZone);
        } else {
            displayDiv.querySelector('.file-name').textContent = fileName;
        }
    } else if (currentDisplay) {
        currentDisplay.querySelector('.file-name').textContent = fileName;
    }
}

document.getElementById('virtualhostForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    const method = '{{if .IsEdit}}POST{{else}}POST{{end}}';
    const url = '{{if .IsEdit}}/api/virtualhosts/{{.VirtualHost.GetID}}{{else}}/api/virtualhosts{{end}}';

    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Virtual host {{if .IsEdit}}updated{{else}}created{{end}} successfully. Changes applied.');
            setTimeout(() => {
                window.location.href = '/virtualhosts';
            }, 2000);
        } else {
            showErrorMessage('Error saving virtual host: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorMessage('Error saving virtual host');
    });
});

function showSuccessMessage(message) {
    showMessage(message, 'success');
}

function showErrorMessage(message) {
    showMessage(message, 'error');
}

function showMessage(message, type) {
    // Remove existing messages
    const existing = document.querySelector('.message-notification');
    if (existing) existing.remove();
    
    // Create message element
    const msgDiv = document.createElement('div');
    msgDiv.className = `message-notification ${type}`;
    msgDiv.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="message-close">&times;</button>
    `;
    
    // Add to page
    document.body.appendChild(msgDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (msgDiv.parentElement) msgDiv.remove();
    }, 5000);
}

// Virtual Host Type Management
document.getElementById('virtualHostType').addEventListener('change', function() {
    const selectedType = this.value;
    const currentType = '{{.VirtualHostType}}';

    // If changing type and it's an edit operation, show warning
    if ('{{.IsEdit}}' === 'true' && selectedType !== currentType) {
        const confirmed = confirm('Changing the virtual host type will require recreating the virtual host with new configuration. All current settings will be lost. Do you want to continue?');
        if (!confirmed) {
            // Reset to original type
            this.value = currentType;
            return;
        }
    }

    const webFields = document.getElementById('webFields');
    const grpcWebFields = document.getElementById('grpcWebFields');
    const grpcWebConfigSection = document.getElementById('grpcWebConfigSection');

    if (selectedType === 'web') {
        webFields.classList.remove('hidden');
        grpcWebFields.classList.add('hidden');
        grpcWebConfigSection.classList.add('hidden');
        
        // Set required attributes for web fields
        document.getElementById('scheme').required = true;
        document.getElementById('hostName').required = true;
        document.getElementById('port').required = true;
        
        // Remove required attributes for gRPC fields
        document.getElementById('grpcHostName').required = false;
        document.getElementById('grpcPort').required = false;
        
    } else if (selectedType === 'grpc-web') {
        webFields.classList.add('hidden');
        grpcWebFields.classList.remove('hidden');
        grpcWebConfigSection.classList.remove('hidden');
        
        // Set required attributes for gRPC fields
        document.getElementById('grpcHostName').required = true;
        document.getElementById('grpcPort').required = true;
        
        // Remove required attributes for web fields
        document.getElementById('scheme').required = false;
        document.getElementById('hostName').required = false;
        document.getElementById('port').required = false;
    }
});

// gRPC Services Management
document.getElementById('addGrpcService').addEventListener('click', function() {
    addGrpcService();
});

function addGrpcService(serviceName = '', methods = ['']) {
    const container = document.getElementById('grpcServicesContainer');
    const serviceDiv = document.createElement('div');
    serviceDiv.className = 'grpc-service-item';
    serviceDiv.innerHTML = `
        <div class="service-header">
            <input type="text" name="grpcServiceName[]" value="${serviceName}" placeholder="service.Name" required>
            <button type="button" class="btn btn-small btn-danger remove-service">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="methods-container" id="methods-${Date.now()}">
            ${methods.map(method => `
                <div class="method-item">
                    <input type="text" name="grpcMethods[]" value="${method}" placeholder="MethodName" required>
                    <input type="hidden" name="grpcServiceName[]" value="${serviceName}">
                    <button type="button" class="btn btn-small btn-danger remove-method">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('')}
            <button type="button" class="btn btn-small btn-secondary add-method">
                <i class="fas fa-plus"></i> Add Method
            </button>
        </div>
    `;
    container.appendChild(serviceDiv);

    // Add event listeners for the new service
    serviceDiv.querySelector('.remove-service').addEventListener('click', function() {
        serviceDiv.remove();
    });

    serviceDiv.querySelector('.add-method').addEventListener('click', function() {
        addGrpcMethod(serviceDiv.querySelector('.methods-container'));
    });

    // Add event listeners for existing methods
    serviceDiv.querySelectorAll('.remove-method').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.method-item').remove();
        });
    });
}

function addGrpcMethod(container, methodName = '') {
    // Get the service name from the parent service item
    const serviceItem = container.closest('.grpc-service-item');
    const serviceNameInput = serviceItem.querySelector('input[name="grpcServiceName[]"]');
    const serviceName = serviceNameInput ? serviceNameInput.value : '';

    const methodDiv = document.createElement('div');
    methodDiv.className = 'method-item';
    methodDiv.innerHTML = `
        <input type="text" name="grpcMethods[]" value="${methodName}" placeholder="MethodName" required>
        <input type="hidden" name="grpcServiceName[]" value="${serviceName}">
        <button type="button" class="btn btn-small btn-danger remove-method">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.insertBefore(methodDiv, container.querySelector('.add-method'));

    methodDiv.querySelector('.remove-method').addEventListener('click', function() {
        methodDiv.remove();
    });

    // Update all hidden service name inputs when service name changes
    serviceNameInput.addEventListener('input', function() {
        const newServiceName = this.value;
        container.querySelectorAll('input[type="hidden"][name="grpcServiceName[]"]').forEach(hidden => {
            hidden.value = newServiceName;
        });
    });
}

// Allowed Origins Management
document.getElementById('allowAllOrigins').addEventListener('change', function() {
    document.getElementById('allowedOriginsGroup').classList.toggle('hidden', this.checked);
});

document.getElementById('addAllowedOrigin').addEventListener('click', function() {
    addAllowedOrigin();
});

function addAllowedOrigin(origin = '') {
    const container = document.getElementById('allowedOriginsContainer');
    const originDiv = document.createElement('div');
    originDiv.className = 'origin-item';
    originDiv.innerHTML = `
        <input type="text" name="allowedOrigins[]" value="${origin}" placeholder="https://example.com" required>
        <button type="button" class="btn btn-small btn-danger remove-origin">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(originDiv);

    originDiv.querySelector('.remove-origin').addEventListener('click', function() {
        originDiv.remove();
    });
}

// Allowed Headers Management
document.getElementById('addAllowedHeader').addEventListener('click', function() {
    addAllowedHeader();
});

function addAllowedHeader(header = '') {
    const container = document.getElementById('allowedHeadersContainer');
    const headerDiv = document.createElement('div');
    headerDiv.className = 'header-item';
    headerDiv.innerHTML = `
        <input type="text" name="allowedHeaders[]" value="${header}" placeholder="x-custom-header" required>
        <button type="button" class="btn btn-small btn-danger remove-header">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(headerDiv);

    headerDiv.querySelector('.remove-header').addEventListener('click', function() {
        headerDiv.remove();
    });
}

// Initialize existing items with event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize required attributes based on current virtual host type
    initializeRequiredAttributes();
    
    // Add event listeners for existing remove buttons
    document.querySelectorAll('.remove-service').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.grpc-service-item').remove();
        });
    });

    document.querySelectorAll('.add-method').forEach(btn => {
        btn.addEventListener('click', function() {
            addGrpcMethod(this.closest('.methods-container'));
        });
    });

    document.querySelectorAll('.remove-method').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.method-item').remove();
        });
    });

    document.querySelectorAll('.remove-origin').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.origin-item').remove();
        });
    });

    document.querySelectorAll('.remove-header').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.header-item').remove();
        });
    });
});

function initializeRequiredAttributes() {
    const selectedType = document.getElementById('virtualHostType').value;
    
    if (selectedType === 'web') {
        document.getElementById('scheme').required = true;
        document.getElementById('hostName').required = true;
        document.getElementById('port').required = true;
        document.getElementById('grpcHostName').required = false;
        document.getElementById('grpcPort').required = false;
    } else if (selectedType === 'grpc-web') {
        document.getElementById('scheme').required = false;
        document.getElementById('hostName').required = false;
        document.getElementById('port').required = false;
        document.getElementById('grpcHostName').required = true;
        document.getElementById('grpcPort').required = true;
    }
}
</script>
{{end}}